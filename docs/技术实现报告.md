# Shopify ChatBot 技术实现报告

## 1. 项目定位与总体目标

该项目是一个面向 Shopify 店铺的智能导购与交易助手，核心能力是：

- 多轮对话式商品推荐
- 订单查询
- 购物车创建/增删改查
- Prompt 在线编辑
- 会话上下文持久化（Redis + MongoDB）

系统基于 FastAPI 提供 HTTP API，调用 OpenAI Responses API（工具调用模式），并通过 MCP Controller 将工具请求路由到向量检索（FAISS）与 Shopify GraphQL 接口。

---

## 2. 系统架构分层

## 2.1 应用入口层（FastAPI）

入口在 `app.py`，主要负责：

1. 生命周期启动：初始化 Redis、SessionManager、PromptManager、MCP Controller、OpenAI client。
2. 路由挂载：`chat`、`prompt`、`auth`、`knowledge_base`。
3. 异常处理：401 时按客户端类型返回 HTML 或 JSON。
4. CORS 与静态文件配置。

### 关键启动动作

- `SessionManager(redis, ttl=3600)`：会话主存。
- `Controller()`：MCP 工具调度中心。
- `PromptManager().init(system.yaml, product.yaml)`：提示词加载。
- `store_session_in_db()`：后台任务监听 Redis 过期事件，将会话落库 MongoDB。

---

## 2.2 对话编排层（routes/chat.py + models.ChatRequest）

### 核心端点

- `POST /async-chat`：标准非流式对话。
- `POST /stream-chat`：SSE 流式输出。
- `POST /test-chat`：固定 mock 响应用于联调。

### 对话主流程（/async-chat）

1. 输入校验：空消息拒绝。
2. 会话加载/创建：若无 `session_id` 则创建，存在则从 Redis 读取历史。
3. 构造消息：`ChatRequest.openai_msgs()` 自动注入系统 prompt。
4. 工具闭环：`process_with_tools()` 循环调用 OpenAI，直到无 `tool_call`。
5. 工具输出回填：MCP Controller 执行工具后，将 tool_output 写回 `history`。
6. 后处理：从模型回复中提取结构化 JSON（product/cart/order）。
7. 会话更新：将历史序列化后写回 Redis。

---

## 2.3 MCP 工具调度层（MCP/controller.py）

`Controller.function_execution()` 根据模型返回的 `tool_call.function.name` 路由到具体能力：

- 检索类：`get_products_data`
- 商品详情：`get_product_via_handle`
- 订单查询：`get_order_via_order_number`
- 购物车：`create_new_cart_with_items / query_cart / add_cartline_items / update_cartline_items / remove_cartline_items`

### 标志位驱动 Prompt 注入

执行工具后，Controller 会根据工具类型追加不同“输出规范 Prompt”：

- 向量检索触发：`append_vectorDb_prompt()` + `append_stuctural_output_prompt()`
- 商品详情触发：`append_stuctural_output_prompt()`
- 购物车触发：`append_cart_output_prompt()`
- 订单触发：`append_order_output_prompt()`

这使模型在下一轮生成时按目标 JSON 结构输出。

---

## 2.4 数据访问层

### 2.4.1 向量检索（RAG/database.py）

- 嵌入模型：`text-embedding-3-small`
- 索引：本地 FAISS（`vectorDb_index_path.index`）
- 元数据：`*_meta.pkl` + `id_to_product_mapping`
- 查询过程：
  1. OpenAI 生成 query embedding
  2. FAISS 相似度搜索
  3. 结果去重并组装为 `{score, content, metadata}`

### 2.4.2 Shopify API（Shopify/shopify.py）

- 使用 Admin GraphQL 与 Storefront GraphQL。
- 主要职责：
  - handle→variant id 映射
  - 购物车创建/查询/修改
  - 订单拉取与格式化
  - 商品详情拉取

---

## 2.5 会话与持久化层

### Redis 会话（utils/session_manager.py）

- 主键：`session:{id}`（有 TTL）
- 影子键：`session:shadow:{id}`（无 TTL）
- 读取会刷新 TTL，实现滑动过期。

### Mongo 落库（utils/persistant_storage.py）

后台 worker 监听 Redis `expired` 事件：

1. 发现 `session:{id}` 过期
2. 从 `session:shadow:{id}` 取完整数据
3. 过滤无效消息，仅保留 user/assistant
4. 写入 Mongo `Chats.chats`
5. 成功后删除 shadow key

---

## 2.6 Prompt 管理层

### PromptManager（utils/PromptManager.py）

- 异步读取 YAML Prompt 文件（`bucket/prompts/system.yaml`, `product.yaml`）
- 提供 `get_system_prompt()` 与 `get_recommend_product_prompt()`
- 支持文件热更新（通过 `handle_realtime_changes` 触发 reload）

### Prompt CRUD API（routes/prompt.py）

- 受 `auth_check` 保护
- `GET/PUT/DELETE /prompts/system`
- `GET/PUT/DELETE /prompts/product`
- 支持在线编辑模板页（`/prompts/edit`）

---

## 2.7 认证与访问控制

`routes/auth.py` 提供：

- 用户注册/登录/刷新/退出
- JWT access + refresh token 机制
- 登录失败次数限制与封禁窗口
- `auth_check` 可从 Header/Cookie 读取 token

补充：项目也存在 `settings.access_token` 的静态 token 校验路径，用于部分受保护接口。

---

## 3. 智能体模块拆解（Agent Modules）

## 3.1 模块清单

1. **Conversation Orchestrator**：`/async-chat` 与 `process_with_tools`
2. **Tool Router (MCP)**：按 function name 执行外部能力
3. **Retriever**：向量检索候选商品
4. **Commerce Executor**：购物车和订单类 Shopify 操作
5. **Prompt Enforcer**：按场景追加输出格式约束 prompt
6. **Structured Extractor**：从自然语言回复中剥离 JSON 对象
7. **Session Memory**：Redis + Mongo 的短期/长期记忆

## 3.2 模块输入输出说明

### 3.2.1 Conversation Orchestrator

- 输入：`ChatRequest(message, session_id, metadata, history)`
- 输出：`ChatResponse(reply, stuctural_data, session_id)`
- 副作用：写会话、记录 token usage

### 3.2.2 Tool Router

- 输入：OpenAI `tool_calls`
- 输出：补充后的 `chat_request.history`（含 `function_call_output`）
- 副作用：追加 prompt 约束标记与 activity trace

### 3.2.3 Retriever（get_products_data）

- 输入：`query`, `top_k_result`
- 输出：字符串 `#VectorDB-<json>`
- 下游用途：模型消费后组织商品推荐

### 3.2.4 Product/Order/Cart 执行器

- 输入：handle / order_number / cart mutation payload
- 输出：结构化 dict 或字符串化 JSON
- 下游用途：模型生成用户可读答案与结构化块

### 3.2.5 Structured Extractor

- 输入：模型文本回复
- 输出：`(objects, cleaned_text)`
  - `objects`: 验证通过的 Product/Cart/Order JSON
  - `cleaned_text`: 去除 JSON 后的自然语言

---

## 4. 端到端时序（核心链路）

## 4.1 商品推荐链路

1. 用户请求（如“推荐 5000 内开发板”）
2. 模型触发 `file_search`/`get_products_data`
3. MCP 调 `vectorDB.query`
4. 结果注入对话历史 + 追加 product output prompt
5. 模型输出自然语言 + ```product JSON 块
6. `extract_json_objects` 提取结构化商品
7. 返回 `ChatResponse(reply + stuctural_data)`

## 4.2 购物车链路

1. 模型识别为 cart intent
2. 触发 `create_new_cart_with_items` 或 `add/update/remove/query_cart`
3. Shopify Storefront GraphQL 执行
4. MCP 回填 tool output 并追加 cart output prompt
5. 模型输出 ```cart JSON
6. API 返回结构化 cart 数据

## 4.3 订单查询链路

1. 用户给出订单号（可无 `#`）
2. MCP 自动补 `order_prefix`（默认 `#`）
3. Shopify 查询订单并格式化
4. 注入 order output prompt
5. 模型输出 ```order JSON + 人类可读解释

---

## 5. 提示词体系（Prompt System）

## 5.1 Prompt 组成

每次新会话至少注入两段系统级提示：

1. `configurable_prompt`：来自 YAML（`system.yaml` 的 `prompt` 字段）
2. `system_prompt`：代码内置的严格 Digilog 商品助手规范

后续根据工具调用动态注入：

- `vector_review_prompt`
- `product_recomendation_prompt`（来自 `product.yaml`）
- `product_output_prompt`
- `cart_output_prompt`
- `order_output_prompt`

## 5.2 提示词目标

- 强约束：只基于检索结果作答，避免幻觉
- 强结构：要求 fenced code block（`product/cart/order`）
- 可解析：字段完整、命名固定，便于后端抽取
- 可执行：购物车与订单输出可直接被前端消费

## 5.3 典型输出格式约束

- 产品：`link/imageurl/title/price/variants_options/description`
- 购物车：`id/checkoutUrl/subtotalAmount/lineItems`
- 订单：宽松校验，识别订单关键字段集合

---

## 6. 工具（Tooling）与函数签名

`MCP/tool_list.py` 中注册工具分为两类：

1. **OpenAI Responses 原生工具**
   - `file_search`（绑定 `vector_store_id`）
   - `get_product_via_handle`
   - `get_order_via_order_number`

2. **扩展工具定义（备用/历史）**
   - `get_products_data`
   - `create_new_cart_with_items`
   - `query_cart`
   - `add_cartline_items`
   - `update_cartline_items`
   - `remove_cartline_items`

> 说明：当前 `tools_list` 实际包含 file_search + 两个 function tool；其余工具定义在独立列表中，若要生效需合并到 `tools_list`。

---

## 7. 数据模型与协议

## 7.1 ChatRequest

关键字段：

- `message`: 用户输入
- `session_id`: 会话标识
- `history`: OpenAI input item 列表
- `metadata`: token usage、flags 等
- `activity_record`: 调用轨迹

关键方法：

- `openai_msgs()`：构造本轮输入消息
- `append_tool_response()`：写入 tool output
- `extract_json_objects()`：抽取结构化对象
- `n_Serialize_chat_history()/n_Deserialize_chat_history()`：会话编解码

## 7.2 ChatResponse

- `reply`: 纯文本回复
- `stuctural_data`: 提取后的 JSON 对象数组
- `session_id`: 前端用于续聊

---

## 8. 可观测性与错误处理

- OpenAI 错误映射：502
- 超时错误映射：504
- 兜底异常：500
- 关键节点日志：用户输入、工具调用、OpenAI 响应、会话持久化

---

## 9. 配置与运行依赖

- 配置来源：`creds/.env`（Pydantic Settings）
- 必需能力：OpenAI Key、Shopify 凭据、Redis、Mongo、FAISS 索引文件
- 主要模型：
  - 聊天模型 `gpt-4.1-2025-04-14`
  - 推理模型 `gpt-5-mini-2025-08-07`（当前聊天主链未直接使用）

---

## 10. 已识别实现特点与改进建议

## 10.1 特点

1. 工具调用闭环清晰：直到无 tool_call 才返回最终文本。
2. Prompt 分层（静态 + 动态）设计利于稳态结构化输出。
3. Redis shadow key + 过期监听是较稳妥的会话归档方案。

## 10.2 改进建议

1. **工具清单一致性**：将 `agentic_feature/vector_db_features` 合并进 `tools_list`，避免“定义存在但不可调用”。
2. **Prompt 文件兜底**：当 `bucket/prompts/*.yaml` 缺失时，提供明确 fallback 与告警。
3. **结构化输出契约测试**：增加针对 `extract_json_objects()` 的单测样本库。
4. **安全策略统一**：`auth_check` 与 JWT 体系并存，建议统一权限模型。
5. **类型与拼写清理**：如 `stuctural_data` 命名拼写可迁移到 `structural_data`（保留兼容层）。

---

## 11. 附：主要输入输出矩阵（摘要）

| 环节 | 输入 | 输出 | 关键副作用 |
|---|---|---|---|
| `/async-chat` | message + session_id | reply + structural_data + session_id | 更新 Redis 会话 |
| `process_with_tools` | openai_msgs + tools | 最终 OpenAI Response | 多轮 tool 调用 |
| `Controller.function_execution` | tool_calls | 增强后的 chat_request | 追加场景 prompt |
| `vectorDB.query` | query/top_k | 候选商品列表 | OpenAI embedding 调用 |
| `Shopify.*cart*` | cart payload | cart dict | 调用 Storefront API |
| `SessionPersistenceWorker` | Redis 过期事件 | Mongo chat record | 删除 shadow key |

---

> 本报告基于当前仓库实现代码静态剖析形成，适用于开发交接、二开设计与上线排障。
