# 新需求技术完善方案（面向当前 Shopify ChatBot 项目）

## 1. 文档目标

本文档用于回答：**基于当前项目实现，如何落地你给出的新一版导购系统设计**。重点给出：

1. 与现有代码的差距评估（Gap Analysis）
2. 可执行的模块化改造方案
3. 各模块输入输出协议（I/O）
4. Prompt 与编排（Orchestrator）落地方式
5. 日志、评估、脚本、目录规范
6. 分阶段实施路径（低风险增量）

---

## 2. 现状与新需求对齐结论

## 2.1 当前已有能力（可复用）

- 对话主链路：`/async-chat` + tool-calling 闭环已具备。
- MCP 控制层：已具备商品检索、订单、购物车能力。
- 会话持久化：Redis（短期）+ Mongo（过期归档）可复用。
- Prompt 动态注入：已支持按工具结果插入结构化输出约束。

## 2.2 新需求关键增量（必须新增）

1. **角色分离**：新增 Orchestrator（编排器）与 Assistant（导购）双阶段。
2. **商品理解模块化**：基于 `products_analyzed.csv` 生成维度分布、归一化映射、欢迎语、店铺概览。
3. **用户理解模块化**：前端 mock 行为输入 → 后端产出 markdown 用户画像 + 个性化欢迎语。
4. **可观测性升级**：模块独立日志 + LLM 输入输出全量记录（脱敏）。
5. **评估体系**：围绕 LLM 不确定性，建立离线评估脚本（LLM-as-judge）。
6. **脚本化运行**：`scripts/start_*` + `setup_conda_env.sh`。

---

## 3. 目标目录结构（增量设计）

> 说明：以下为建议结构，采用“兼容现有代码、逐步迁移”的方式。

```text
chatbot_Shopify/
├── assistant/
│   ├── orchestrator.py
│   ├── responder.py
│   ├── prompts/
│   │   ├── orchestrator_system.md
│   │   └── assistant_system.md
│   ├── schemas/
│   │   ├── orchestration_plan.schema.json
│   │   └── final_response.schema.json
│   └── README.md
├── product_understanding/
│   ├── process_products.py                 # 已有
│   ├── output_logs/
│   │   ├── products_analyzed.csv           # 已有
│   │   ├── dimension_topk.json
│   │   ├── normalization_mapping.json
│   │   ├── distribution_digest.md
│   │   └── welcome_messages.json
│   ├── offline_pipeline.py
│   ├── service.py
│   └── README.md
├── user_understanding/
│   ├── profile_builder.py
│   ├── welcome_personalizer.py
│   ├── schemas/
│   │   ├── user_raw_events.schema.json
│   │   └── user_profile_markdown.schema.json
│   ├── storage/
│   │   └── mock_profiles/
│   └── README.md
├── evaluation/
│   ├── datasets/
│   ├── rubrics/
│   ├── eval_orchestrator.py
│   ├── eval_assistant.py
│   ├── eval_search_quality.py
│   └── README.md
├── data/
│   ├── tenants/
│   ├── seasonal_context/
│   └── cache/
├── scripts/
│   ├── setup_conda_env.sh
│   ├── start_product_module.sh
│   ├── start_user_module.sh
│   ├── start_agent_module.sh
│   └── start_web.sh
└── docs/
    ├── 新需求技术完善方案.md
    ├── assistant_模块设计.md
    ├── product_understanding_模块设计.md
    └── user_understanding_模块设计.md
```

---

## 4. 三大模块技术方案

## 4.1 assistant 模块（导购智能体）

## 4.1.1 模块职责

1. 首轮欢迎语选择（店铺欢迎语/个性化欢迎语）
2. 每轮先执行编排器（Orchestrator）产出计划对象
3. 执行工具清单（商品分布/搜索/穿搭/web）
4. 汇总技能结果后调用 Assistant 生成用户回复
5. 记录中间过程（计划、工具结果、最终回复）

## 4.1.2 两阶段调用流程

1. `plan = Orchestrator.plan(context)`
2. `tool_results = ToolExecutor.run(plan.tool_plan)`
3. `reply = Assistant.respond(context + plan + tool_results)`
4. `memory_update_event`（可异步）

## 4.1.3 Orchestrator 输出协议（建议采用 Function Calling）

```json
{
  "stage": "early|clarify|converge",
  "intent": {
    "category": null,
    "scene": [],
    "effect": [],
    "style": [],
    "audience": null,
    "budget": null,
    "size": null,
    "season": null,
    "region": null,
    "hard_constraints": []
  },
  "gap_assessment": {
    "missing_slots": [],
    "why_important": {}
  },
  "tool_plan": [
    {
      "tool": "product_dist_lookup",
      "priority": 1,
      "must": true,
      "reason": "...",
      "args": {}
    }
  ],
  "candidate_queries": {
    "fuzzy_slots": {"category": "", "scene": "", "effect": "", "style": ""},
    "search_queries": []
  },
  "questions_to_ask": [
    {"q": "...", "options": []}
  ],
  "response_strategy": {
    "recommend_first_then_ask": true,
    "recommendation_count": 2,
    "info_density": "mid"
  },
  "confidence": 0.78
}
```

## 4.1.4 Assistant 回复策略

- 输出结构：`补信息 + 推荐 + 轻引导`。
- 缺口大：先给 2–3 个方向 + 最多 2 个用户立场问题。
- 缺口小：直接给明确推荐，并补充“为什么适合你”。
- 用户感知：像真人导购，不机械问参数。

---

## 4.2 product_understanding 模块（商品理解）

## 4.2.1 离线任务输入

- 文件：`./product_understanding/output_logs/products_analyzed.csv`
- 关键列：
  - `category_path`
  - `tags`
  - `target_audience`
  - `usage_scene`
  - `season`
  - `key_attributes/material/features/selling_points`

## 4.2.2 离线任务输出

1. **分维度 topK 统计**（top50）
2. **归一化体系与映射关系**
3. **每个归一化项的分布概览 + 示例商品**
4. **店铺内容分布简介（distribution digest）**
5. **欢迎语候选 10 条（店铺级）**

## 4.2.3 技能接口（在线）

### skill: product_distribution

- 输入：`dimension_type`, `dimension_value`
- 输出：
  - 该维度分布摘要
  - 高频子项
  - 示例商品 markdown

### skill: product_search_fuzzy

- 输入：`category/tags/scene/effect` 等宽泛意图
- 逻辑：
  1. LLM 从“维度 keylist”筛 key
  2. 逐 key 拉取概览 markdown
  3. 汇总为“临时推荐方向”

### skill: product_search_exact

- 输入：明确搜索词
- 逻辑：
  1. 调商品搜索 API
  2. 提取 top30 标题
  3. LLM 判断满足度 + 改写 query + 精选商品ID + 总结

---

## 4.3 user_understanding 模块（用户理解/画像）

## 4.3.1 输入（前端 mock）

- 最近点击/加购/购买（各 20）
- 搜索记录（40，最近 10 含细节）
- AI 导购对话压缩记录（40）

## 4.3.2 输出

1. markdown 用户画像（含更新时间、触发事件）
2. 个性化欢迎语
3. 离线推荐商品列表（可选）

## 4.3.3 画像结构（markdown）

1. 慢变偏好（人群/尺码/风格/品牌态度）
2. 半稳定场景（通勤/日常/旅行/功能诉求）
3. 明确约束（禁忌/雷区）
4. 行为证据摘要（每条偏好需可追溯）

---

## 5. 动态编排层（Orchestrator）落地建议

## 5.1 首选方案：Function Calling Planner

原因：

- JSON 强约束，后端好解析
- 能直接驱动工具执行
- 比 `<ORCHESTRATION>...</ORCHESTRATION>` 文本块更稳

## 5.2 触发 web_search 的严格条件

仅在以下场景触发：

1. 强时效趋势问题（季节潮流、新概念）
2. 用户不知道品类名称，需要“反推可搜索名词”
3. 穿搭建议需外部气候/趋势知识补充

否则不触发，避免噪音与成本上升。

## 5.3 槽位缺口驱动策略

- 缺口大：`ask_first_then_recommend` 或 `recommend_first_then_ask`
- 缺口小：`pure_recommend` 或 `compare + recommend`
- 每轮最多 2 问，问题必须站在用户立场（感受/场景/预算/雷区）

---

## 6. 与现有代码的集成改造建议

## 6.1 路由层

在现有 `routes/chat.py` 中新增一个分支：

- `POST /async-chat-v2`
  - Step1 调 planner（Orchestrator）
  - Step2 执行 `tool_plan`
  - Step3 调 assistant 产出最终回复

> 保留旧 `/async-chat`，以灰度方式迁移。

## 6.2 MCP 扩展

在 `MCP/tool_list.py` 注册新增工具：

- `product_distribution`
- `product_search_fuzzy`
- `product_search_exact`
- `result_summarize`
- `style_agent`
- `compare_agent`
- `web_search_trend`

在 `MCP/controller.py` 增加对应执行函数，并统一结构化输出。

## 6.3 Context 管理

将上下文分为 4 块：

1. 用户画像（长期）
2. 动态补充（编排+工具）
3. 最近 10 轮对话
4. 系统角色与店铺分布摘要

对超过长度的历史做摘要压缩（优先压缩 7 轮前）。

---

## 7. Prompt 体系重构建议

## 7.1 Orchestrator Prompt（内部）

目标：稳定输出 plan JSON，不直接对用户说话。

关键约束：

- 只输出 JSON
- 每轮最多 2 个问题
- 先判断缺口再决定是否搜索
- 对 web_search 保持克制

## 7.2 Assistant Prompt（对用户）

目标：人性化导购表达。

关键约束：

- 吸收工具结果，不暴露系统内部动作
- 话术“共情 + 专业 + 灵活”
- 给推荐时必须给理由（场景/风格/功能）

---

## 8. 日志与可观测性

## 8.1 日志文件规划（独立前缀）

- `Logs/assistant_*.log`
- `Logs/orchestrator_*.log`
- `Logs/product_understanding_*.log`
- `Logs/user_understanding_*.log`
- `Logs/evaluation_*.log`

## 8.2 必记日志点

1. LLM 输入摘要 + 模板版本号
2. LLM 输出（原始 JSON / 关键字段）
3. 工具调用参数、耗时、结果条数
4. 搜索 query 改写链路
5. 最终回复与置信度

> 注意脱敏：屏蔽 token、邮箱、手机号等敏感字段。

---

## 9. 评估（TDD + LLM 评测）

## 9.1 评估维度

1. 意图识别完整度
2. 问题质量（是否用户立场）
3. 推荐相关性
4. 推荐理由质量
5. 工具调用合理性（是否滥用 web_search）
6. 对话推进能力（是否促成下一步）

## 9.2 评估方式

- 测试集：构造 100+ 多轮样本（早期意图模糊/明确搜索/对比决策等）
- 双评估：规则分 + LLM-as-judge（参考 LangSmith 思路）
- 输出：`evaluation/reports/*.json` 与回归趋势图

---

## 10. 脚本与运行环境建议

## 10.1 scripts

- `scripts/setup_conda_env.sh`
  - 创建 `aishopping-py312`
  - 安装依赖（含 langchain、tavily）
- `scripts/start_product_module.sh`
- `scripts/start_user_module.sh`
- `scripts/start_agent_module.sh`
- `scripts/start_web.sh`（端口 `6008`）

## 10.2 环境变量

- `DASHSCOPE_API_KEY`
- `TAVILY_API_KEY`
- `SEARCH_API_BASE_URL`（对接《搜索API对接指南.md》）
- 兼容保留：`OPENAI_API_KEY`（平滑迁移期）

---

## 11. 分阶段实施计划（推荐）

## Phase 1：文档与离线产物（低风险）

1. 完成三大模块设计文档
2. 打通 product_understanding 离线统计产物
3. 产出店铺分布摘要 + 欢迎语 10 条

## Phase 2：编排器上线（灰度）

1. 新增 `/async-chat-v2`
2. 引入 planner JSON 输出
3. 接入 `product_distribution/product_search_exact/fuzzy`

## Phase 3：用户理解与个性化

1. 前端 mock 行为输入
2. 后端生成 markdown 用户画像
3. 个性化欢迎语与离线推荐

## Phase 4：评估与优化

1. 评估脚本全量跑通
2. 基于误差样本迭代 prompt / tool 策略
3. 决定是否将 v2 替换为默认主链路

---

## 12. 风险与规避

1. **LLM 结果不稳定**：通过 JSON schema + retry + validator 控制。
2. **工具调用成本高**：planner 加 must/priority，限制 web_search 触发。
3. **上下文过长**：分层上下文 + 历史压缩策略。
4. **可解释性不足**：保留编排计划和技能执行日志。
5. **迁移风险**：保留旧链路并灰度切流。

---

## 13. 交付物清单（本次文档层）

本轮建议先完成以下文档与规范落地，再进入代码实现：

1. `docs/新需求技术完善方案.md`（本文件）
2. `docs/assistant_模块设计.md`
3. `docs/product_understanding_模块设计.md`
4. `docs/user_understanding_模块设计.md`
5. `docs/evaluation_评测规范.md`

---

## 14. 结语

该方案以“**兼容现有工程 + 分阶段改造**”为核心原则：

- 不推倒重来，保留现有 FastAPI + MCP + Session 主体；
- 引入 Orchestrator 作为新中枢，实现“先思考再回复”；
- 通过 product/user 两个模块把“懂货 + 懂人”补齐；
- 用评估驱动 Prompt 与工具策略持续迭代。

这条路线可以较快把当前系统升级为“更像真人导购”的智能体系统。
